From 15f720e78f660cebf3e8e214ac8e09758108ddba Mon Sep 17 00:00:00 2001
From: Kamil Tokarski <ktokarski@nvidia.com>
Date: Wed, 17 Aug 2022 10:14:45 +0200
Subject: [PATCH] Port OpenEuler fix to CVE-2021-33643

---
 lib/block.c | 10 ++++++++++
 1 file changed, 10 insertions(+)

diff --git a/lib/block.c b/lib/block.c
index 30a8387..32a98f1 100644
--- a/lib/block.c
+++ b/lib/block.c
@@ -129,6 +129,11 @@ th_read(TAR *t)
 	if (TH_ISLONGLINK(t))
 	{
 		sz = th_get_size(t);
+		if ((int)sz <= 0)
+		{
+			errno = EINVAL;
+			return -1;
+		}
 		blocks = (sz / T_BLOCKSIZE) + (sz % T_BLOCKSIZE ? 1 : 0);
 		if (blocks > ((size_t)-1 / T_BLOCKSIZE))
 		{
@@ -179,6 +184,11 @@ th_read(TAR *t)
 	if (TH_ISLONGNAME(t))
 	{
 		sz = th_get_size(t);
+		if ((int)sz <= 0)
+		{
+			errno = EINVAL;
+			return -1;
+		}
 		blocks = (sz / T_BLOCKSIZE) + (sz % T_BLOCKSIZE ? 1 : 0);
 		if (blocks > ((size_t)-1 / T_BLOCKSIZE))
 		{
-- 
2.25.1

